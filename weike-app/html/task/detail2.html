<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
  <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
  <title>Hello APP</title>
  <link rel="stylesheet" type="text/css" href="../../css/api.css" />
  <link rel="stylesheet" type="text/css" href="../../css/assets/main.css" />
  <style>
  .header-mix .mix-txt {
      position:absolute;
      top:20px;
  }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
        <span class="header-mix" onclick="api.closeWin();">
            <span class="mix-txt"><i class="header-icon icon-v-left js-back"></i>数据采集</span>
        </span>
    </div>

</header>
<div class="pages">
    <section class="section">
        <div class="nav-user col-ff9"><span id="titleContent"></span>
            <div class="nav-user-rg" id="saveBtn" onclick="subData();">
                <a>保存</a>
            </div>

        </div>
        <div class="h15 bg-f5f"></div>
        <h4 class="pages-tag">推荐产品：</h4>
        <div class="form-item">
            <label class="item-label">客户职业 :</label>
            <div class="item-field">
                <select id="cusJobNtype">
                  <option value="">请选择</option>
                  <option id="cusJobNtypeZ" value="Z">Z-政府行政类</option>
                  <option id="cusJobNtypeS" value="S">S-商户类</option>
                  <option id="cusJobNtypeB" value="B">B-职员类</option>
                  <option id="cusJobNtypeN" value="N">N-农户类</option>
                </select>
            </div>
            <i class="icon-v-right-rg icon-icon-right"></i>
        </div>
        <div class="form-item">
            <label class="item-label">资产状况 :</label>
            <div class="item-field">
                <select id="cusAssetsNtype">
                  <option value="">请选择</option>
                  <option id="cusAssetsNtypeG" value="G">G-高档小区业主</option>
                  <option id="cusAssetsNtypeC" value="C">C-车主</option>
                  <option id="cusAssetsNtypeP" value="P">P-普通小区业主</option>
                </select>
            </div>
            <i class="icon-v-right-rg icon-icon-right"></i>
        </div>
        <div class="form-item">
            <label class="item-label">年龄分类 :</label>
            <div class="item-field">
                <select id="cusAgeNtype">
                  <option value="">请选择</option>
                  <option id="cusAgeNtypeY" value="Y">Y-30（不含）岁以下</option>
                  <option id="cusAgeNtypeM" value="M">M-30（含）-50（不含）岁</option>
                  <option id="cusAgeNtypeO" value="O">O-50（含）岁以上</option>
                </select>
            </div>
            <i class="icon-v-right-rg icon-icon-right"></i>
        </div>
        <div class="h15 bg-f5f"></div>
        <h4 class="pages-tag">沟通结果：</h4>
        <div class="col-repay">
            <div>
              <input type="radio" id="logResult1" name="logResult" onclick="showAndHideView()" value="1"/>成功营销  &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
              <input type="radio" id="logResult2" name="logResult" onclick="showAndHideView()" value="2"/>约访成功  &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
              <input type="radio" id="logResult3" name="logResult" onclick="showAndHideView()" value="3" checked />待确定
            </div>
        </div>
        <div class="h15 bg-f5f"></div>
        <h4 class="pages-tag">继续跟进：</h4>
        <div class="col-repay">
            <div class="form-lb-fs" id="div_logNtype"><input type="radio" id="logNtype" name="logNtype" value="" checked/>无</div>
            <div class="form-lb-fs" id="div_logNtype1"><input type="radio" id="logNtype1" name="logNtype" value="1"/>客户对产品有兴趣,但未能成功约访</div>
            <div class="form-lb-fs" id="div_logNtype2"><input type="radio" id="logNtype2" name="logNtype" value="2"/>客户沟通顺畅,不抵触产品推荐</div>
            <div class="form-lb-fs" id="div_logNtype3"><input type="radio" id="logNtype3" name="logNtype" value="3"/>客户忙,未能沟通</div>
            <div class="form-lb-fs" id="div_logNtype4"><input type="radio" id="logNtype4" name="logNtype" value="4"/>客户表示可以另约时间沟通</div>
            <div class="form-lb-fs" id="div_logNtype5"><input type="radio" id="logNtype5" name="logNtype" value="5"/>电话未接通</div>

        </div>
        <div id="threeMonthsContact" style="">
          <div class="h15 bg-f5f"></div>
          <h4 class="pages-tag">三个月以后再联系：</h4>
          <div class="col-repay">
              <div class="form-lb-fs"><input type="radio" id="logThreemonty" name="logThreemonty" value="" checked/>无</div>
              <div class="form-lb-fs"><input type="radio" id="logThreemonty1" name="logThreemonty" value="1"/>客户直接挂断电话</div>
              <div class="form-lb-fs"><input type="radio" id="logThreemonty2" name="logThreemonty" value="2"/>客户直接拒绝,且态度强硬</div>
              <div class="form-lb-fs"><input type="radio" id="logThreemonty3" name="logThreemonty" value="3"/>电话停机或空机</div>
          </div>
        </div>
        <div class="h15 bg-f5f"></div>
        <h4 class="pages-tag">备注：</h4>
        <div class="col-repay">
          <textarea style="width:100%;" id="comment"></textarea
        </div>
        <div class="h15 bg-f5f"></div>
    </section>
</div>

</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/config.js"></script>
<script type="text/javascript" src="../../script/util.js"></script>
<script type="text/javascript">
    var cusObj;
    apiready = function(){
      var header = $api.dom('header');
      //适配iOS 7+，Android 4.4+状态栏
      $api.fixStatusBar(header);
      initPage();
      util.globalInit();
      iosListener();
      window.onload= showAndHideView();
		};


    function initPage() {
      cusObj = api.pageParam.cusObj
      if(!cusObj){
        util.toast("网络异常");
      }else{
        const state = cusObj.state
        $api.html($api.byId('titleContent'), "与客户2【<u style='color:red;' onclick='editPage();'>"+cusObj.cusName+"</u>】的沟通结果");

        document.getElementById('cusJobNtype'+cusObj.cusJobNtype).selected = true;
        document.getElementById('cusAssetsNtype'+cusObj.cusAssetsNtype).selected = true;
        document.getElementById('cusAgeNtype'+cusObj.cusAgeNtype).selected = true;

        //查询历史数据
        util.get("CusLog/getById",{cusId:cusObj.cusId},function (json) {
          if(json.data){
            // $api.attr($api.byId("logResult"+json.data.logResult), "checked", "checked");
            //使用点击事件替换上边的设置操作
            var logR = document.getElementById("logResult"+json.data.logResult);
            if(document.all) {
                logR.click();
            }
            // 其它浏览器
            else {
              var e = document.createEvent("MouseEvents");
              e.initEvent("click", true, true);　　　　　　　　　　　　　　//这里的click可以换成你想触发的行为
              logR.dispatchEvent(e);　　　//这里的clickME可以换成你想触发行为的DOM结点
            }

            $api.attr($api.byId("logNtype"+json.data.logNtype), "checked", "checked");
            $api.attr($api.byId("logThreemonty"+json.data.logThreemonty), "checked", "checked");
            $api.text($api.byId("comment"), json.data.comment);
          }
        })
      }

    }

    function editPage() {
      if(!cusObj){
        util.toast("网络异常");
      }else{
        api.openWin({
            name: 'editCus',
            url: '../addCus.html',
            pageParam: {
                cusObj: cusObj
            }
        });
      }
    }
    var paramVal = {
      cusId: "",
      cusPhone: "",
      systemType: "",
      logResult: "",//沟通结果
      logNtype: "",
      logThreemonty: "",
      comment: "",
      logTime: '',  //沟通时间
      logTimelong: 0, //沟通时长
      cusJobNtype: "",
      cusAssetsNtype: "",
      cusAgeNtype: ""
    }
    function subData() {
      //获取页面参数
      paramVal.cusId = cusObj.cusId;
      paramVal.cusPhone = cusObj.cusPhone;
      paramVal.systemType = api.systemType;
      paramVal.logResult = $api.val($api.dom(":checked[name=logResult]"));
      paramVal.logNtype = $api.val($api.dom(":checked[name=logNtype]"));

      if(paramVal.logNtype == '3'){
        paramVal.logThreemonty = $api.val($api.dom(":checked[name=logThreemonty]"))
      }

      paramVal.comment = $api.val($api.byId("comment"))
      paramVal.cusJobNtype = $api.val($api.byId("cusJobNtype"))
      paramVal.cusAssetsNtype = $api.val($api.byId("cusAssetsNtype"))
      paramVal.cusAgeNtype = $api.val($api.byId("cusAgeNtype"))

      var systemType = paramVal.systemType;
      if(systemType == "android"){
        //获取手机通话记录
        androidPhone();
      }else if(systemType == "ios"){
        iosPhone();
      }else{
        util.toast("当前系统不支持此接口");
      }
    }

    function iosPhone() {
      if(startTime != 0 && endTime != 0){
        paramVal.logTime = startDate;
        paramVal.logTimelong = parseInt((endTime - startTime) / 1000);
      }
      saveData(paramVal);
    }

    function androidPhone() {
      var callRecord = api.require('callRecord');
      callRecord.openCallRecord(function(ret) {
        if(ret.status){
          const callR = ret.CallRecord
          const startInd = callR.length - 1
          for (var i = startInd; i >= 0; i--) {
              const oneObj = callR[i]
              if (paramVal.cusPhone == oneObj.number && oneObj.type == "呼出") {
                paramVal.logTime = oneObj.time
                paramVal.logTimelong = oneObj.duration
                saveData(paramVal);
                break;
              }else{
                if(i==0){
                  util.toast("没有找到手机号为"+paramVal.cusPhone+"的通话记录")
                }
              }
          }
        }else{
          alert(JSON.stringify(ret));
        }
      });
    }

    var startDate = "";
    var startTime = 0;
    var endTime = 0;
    var str = "";

    function iosListener() {
      var systemType = api.systemType;
      if(systemType == "ios"){
        var phoneListener = api.require('phoneListener');
        phoneListener.callStateListener({
          enable : true
        },
        function(ret) {
          // if(ret.phoneNumber == cusObj.cusPhone){
          if(startTime == 0 && ret.state == "OFFHOOK"){
            var d = new Date();
            startDate = d.format("yyyy-MM-dd hh:mm:ss");
            startTime = d.getTime();
          }else if(startTime != 0 && endTime == 0 && ret.state == "IDLE"){
            endTime = new Date().getTime();
          }
          // }
        });
      }
    }
    function saveData(paramVal) {
      util.post("CusLog/addData",paramVal,function (json) {
        util.toast("数据已保存")
        util.refresh();
      })
    }
    /**
    * 控制界面元素显示隐藏
    * isInit 0 非初始化,1 初始化
    */
    function showAndHideView() {
      var result = $api.val($api.dom(":checked[name=logResult]"));
      if(result == '1'){
        $api.css($api.byId('threeMonthsContact'),"display:none");
        $api.css($api.byId("div_logNtype3"),"display:none");
        $api.css($api.byId("div_logNtype4"),"display:none");
        $api.css($api.byId("div_logNtype5"),"display:none");
        $api.css($api.byId("div_logNtype1"),"display:block");

      }else if(result == '2'){
        $api.css($api.byId('threeMonthsContact'),"display:none");
        $api.css($api.byId("div_logNtype4"),"display:block");

        $api.css($api.byId("div_logNtype1"),"display:none");
        $api.css($api.byId("div_logNtype3"),"display:none");
        $api.css($api.byId("div_logNtype5"),"display:none");

      }else{
        $api.css($api.byId('threeMonthsContact'),"display:block");
        $api.css($api.byId("div_logNtype3"),"display:block");
        $api.css($api.byId("div_logNtype4"),"display:block");
        $api.css($api.byId("div_logNtype5"),"display:block");

        $api.css($api.byId("div_logNtype1"),"display:block");
        $api.css($api.byId("div_logNtype3"),"display:block");
        $api.css($api.byId("div_logNtype5"),"display:block");
      }

    }
</script>
</html>
